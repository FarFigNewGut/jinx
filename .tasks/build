#!/usr/bin/env ruby
require("fileutils")
require("json")
require('digest')
require_relative("common/color")
require_relative("common/log")

FileUtils.mkdir_p("dist/assets")
available = Dir.glob("lib/*")
manifest = {available: [], last_updated: Time.now.to_i}

available.each {|script|
  Log.out("packaging %s" % File.basename(script), label: %i(jinx info))
  cdn_path = "/assets/%s" % File.basename(script)
  FileUtils.cp(script, "dist%s" % cdn_path)
  manifest[:available] << {
    file: cdn_path, 
    last_modified: File.mtime(script).to_i,
    md5: Digest::MD5.file(script).hexdigest,
  }
}

Log.out("creating jinx manifest", label: %i(jinx info))
File.write("dist/manifest.json", 
  JSON.pretty_generate(manifest))